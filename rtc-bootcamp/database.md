# DB of Oracle How to

## Oracle

### インスタンス

メモリ
    - SGA（キャッシュ領域）
        - 表データ、実行計画、SQL
    - PGA
        - プロセスごとのメモリ
- プロセス
    - リスナープロセス

データベースファイル
- データファイル
    - 格納先
    -    生データのバイナリ
- 制御ファイル
    - DBの構造データ
- REDOログ

### メモリー管理

２つの選択肢。

- 自動メモリ管理
    - SGA+PGAの自動最適化
- 自動共有メモリ管理
    - SGAの自動最適化

#### SGA

プロセス管理の共有メモリ
`SGA_MAX_TARGET`で設定

- DBバッファ：　データのキャッシュ
- 共有プール：　SQL解析結果のキャッシュなど
- REDOプール: REDOのキャッシュ


#### PGA

サーバープロセスのSQL作業メモリ領域ー＞リクエストごとのメモリ領域

#### データベースファイル

##### 制御ファイル（バイナリ）

DBの構造を格納
チェックポイント情報（コミットポイントの記録など）
データベースファイルの名前と場所とか
コマンドでテキストできれる

##### REDOログファイル

更新情報を順番に記録しておき、復旧に利用。非同期
ファイルは循環利用されるため、更新量の調整必要
書き込みのフックとしてh

- コミット時
- SGAのメモリ領域の三分の一を使った時点
- 前回書き込みから三秒後
- ダーティバッファをDBWnが書き込む前

##### 設定ファイル

テキストで記述でき、バイナリで運用される。

#### 論理領域管理 ここ大事

##### 表領域

表領域は表の論理的な格納先。データファイルは物理的なデータの保存先。

##### 事前(default)定義の表領域

こんな感じの倫理構造になっている

Segment　> Extent  > block

Oracleはブロック単位でアクセス

#### Index

B*tree索引

ツリー構造になっているIndex。範囲検索やカーディナリティ（データの種類）が高い検索に効果
ROWID情報と列値データをソートして格納

**インデックスの重要な格納ルールに、ブランチ、リーフには必ず昇順(降順)に検索キー(※2)を格納する必要がある**

#### パーティショニング

データを論理的に区切って、管理する方法。
区切り方によって、レンジ（日付）、リスト（コードや区分）、ハッシュなどの方法で分ける

## クラスタリング

### シェアードエブリシング

### シェアードナッシング

oracleはこっち。
1ノード１マスターはもちろん。
各サーバ固有のディスクで処理を行ことで、各サーバのスループットを最大化する。ストレージ（データファイルは同じ）。
**キャッシュフュージョンで各ノードの情報の整合性を整える**コスト大きので、むやみに適当にノードに投げない。同じリソースアクセスは同じノードにリクエストするようにアプリ側でさばいてあげるとキャッシュフュージョン低くなる。こういう設計する必要がある。かいいんIDとか、カスタマーとか企業とか。アプリケーション側にロジックを仕込んでいる。そしてポートしてい。

## 性能問題

事実確認が大事。予想はだめ。まずはログ基盤しっかり盛り込めよ。

### アプローチ

1. 現状の分析
2. **目標値の決定**
3. チューニング方針の決定
    4. スループットやレスポンスの改善なのかリソースの省エネか
4. チューニングの実施

#### スループットかレスポンスか

単位時間あたりの処理量や、応答時間なのか。

#### リソース使用量が増えている

なんで増えたかの把握が大切

- ユーザー数ふえた？
- 機能追加

ワークロードが変わった？
利用者数の伸び
アクセスするデータに変化
機能追加


#### チューニングのススメ方

一般的にビジネスロジックを見直したほうが効果が高い！！
ビジネスロジックのある部分をやめるとかの判断も十分候補に上がってくる

## チューニングの概念

DBの動作

1. SQL解析し、実行計画を作成
2. 実行計画をもとに実行順作成
3. 実行

SQLはアルゴリズムを書かずにデータ抽出条件のいをかけばよい。

**具体的にはバインド変数を使う, など。**

### Parseのチューニング

SQLをパースして解析されたものをメモリにキャッシュする方法。

ハードケース（実行計画を作成）はCPUで解析

ソフトケースはキャッシュを利用。

なるべくキャッシュを用いてSQLをパースしようというチューニング。

### 実行計画

SQLは一意でも複数の検索の仕方がありえる。良い実行計画をするようにチューニングする。

そのためには、実行計画をつくるparserが知っている必要がある。

#### アナライズ

ワーカーで事前に各テーブルのデータ量等の情報を調査して定期的に集計するようすにしてDBに保管。注意としては、情報が変化するので定期的にアナライズするなどがある。

#### ヒント句

ヒント句をSQLに埋め込むと、実行計画を人間側で選択できる。

必ず実行されるものでもない。ただ統計情報をいじるだけなので。

#### 具体例

データの